# 트랜잭션 격리 수준

MySQL(InnoDB)의 격리 수준은 트랜잭션의 일관성(Consistency)과 동시성(Concurrency) 사이의 균형을 맞추는 설정입니다.

mysql에서 제공하는 트랜잭션 격리 수준은 크게 4가지가 있습니다. 

(1) Read uncommitted, (2) read committed, (3) repeatable Read, (4) serializable입니다.

### 1. READ UNCOMMITTED

설명 : 가장 낮은 격리 수준입니다. 트랜잭션 A가 데이터를 변경하고 아직 커밋하지 않았는데도, 트랜잭션 B가 그 변경된 값을 읽을 수 있습니다.

문제점 : **Dirty Read** 
작업 중 에러가 발생해 롤백(Rollback)이 되면, 트랜잭션 B는 존재하지 않는 데이터를 정상 데이터로 착각하고 처리하게 됩니다.

결론 : 데이터 정합성에 치명적이므로 일반적인 서비스에서는 거의 사용하지 않습니다.

### 2. READ COMMITTED

설명 : 트랜잭션이 커밋을 완료한 데이터만 다른 트랜잭션에서 읽을 수 있습니다. 오라클(Oracle)이나 PostgreSQL의 기본 설정입니다.

동작 원리 : 변경 중인 데이터(Dirty Data)는 테이블에 있지만, SELECT 요청이 오면 **UNDO LOG**에 백업된 이전 데이터를 읽어옵니다.

문제점 :**Non-Repeatable Read**
하나의 트랜잭션 안에서 똑같은 SELECT를 두 번 수행했는데, 그 사이에 다른 트랜잭션이 데이터를 수정하고 커밋해버리면 두 결과가 다르게 나옵니다. (반복 읽기 불가능)

![download](https://github.com/user-attachments/assets/ed7170e9-752f-4120-a5aa-519c778cb562)

=> (이를 해결하기 위해서 REPEATABLE READ 등장)

### 3. REPEATABLE READ

설명: 트랜잭션이 시작된 시점의 상태를 기준으로 데이터를 읽습니다. 즉, 트랜잭션 내에서는 항상 동일한 결과를 보장합니다.

> 트랜잭션 시점으로 **SNAPSHOT**을 생성해서 그 데이터만 보여줌.

동작 원리 : 
```
내 트랜잭션 ID: 100번

읽으려는 데이터의 ID:

  - 데이터에 적힌 ID가 100보다 작거나 같다? 👉 "과거거나 내 거네. 읽어도 됨."

  - 데이터에 적힌 ID가 100보다 크다? (예: 150번) 👉 "나보다 미래에 온 놈(다른 트랜잭션)이 바꿨네? 안 읽어."

미래 데이터(150번)를 만났을 때의 행동

  - 실제 테이블 값은 무시하고, 언두 로그(Undo Log)로 갑니다.

  - 언두 로그를 뒤져서 ID가 100번 이하인 가장 최신 기록을 찾아내 복구해서 읽습니다.
```

결론 : read committed과 차이점은 트랜잭션 내내 데이터가 일정하다는 것이다.

#### 추가 (Phantom read와 InnoDB)
Phantom Read: 원래 표준 SQL 정의상으로는, 이 단계에서 다른 사람이 데이터를 INSERT 하면 내 트랜잭션에서 안 보이던 데이터가 갑자기 툭 튀어나오는(유령처럼) 현상이 발생해야 합니다.

InnoDB의 방어: 하지만 MySQL InnoDB는 Next-Key Lock(갭 락)을 사용하여, 다른 트랜잭션이 내 조회 범위 안에 데이터를 끼워 넣지(Insert) 못하게 막습니다. 
따라서 InnoDB의 Repeatable Read에서는 Phantom Read가 거의 발생하지 않습니다.

### 4. SERIALIZABLE

동시성 버리고, 엄격한 격리를 선택한 격리 수준입니다.
 ==> 가장 엄격한 격리 수준입니다. 말 그대로 트랜잭션을 줄 세워서 순서대로 처리하는 것과 같습니다.

동작 원리
- 단순한 SELECT 문장도 내부적으로 SELECT ... FOR SHARE(공유 락)로 변환됩니다.

- 즉, "내가 읽는 동안은 아무도 수정 못해"라고 락을 걸어버립니다.

결론: 동시 처리 성능이 급격히 떨어지므로, 데드락(Deadlock)이 빈번하고 성능이 중요한 서비스에서는 거의 사용되지 않습니다.


## 한! 눈! 요! 약 !

|격리수준 | 발생 문제 | 특징 |
| --- | ----- | ------------------- |
|Read Uncommitted | Dirty Read | 커밋 안된 것 읽음. 데이터 꼬임 |
|Read committed | non-repeatable read | 커밋된 것만 읽음. 데이터가 계속 바뀔수도|
|Repeatable Read | - | 트랜잭션 시작 시점의 **SNAPSHOT**을 읽음 |
|Serializable | 느림(동시성 불가) | 읽기 작업에도 락 걺|
